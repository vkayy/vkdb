\chapter{Internals}
\hypertarget{md_internals}{}\label{md_internals}\index{Internals@{Internals}}
\label{md_internals_autotoc_md4}%
\Hypertarget{md_internals_autotoc_md4}%
\hypertarget{md_internals_autotoc_md5}{}\doxysection{\texorpdfstring{Database engine}{Database engine}}\label{md_internals_autotoc_md5}
vkdb is built on log-\/structured merge (LSM) trees. In their simplest form, these have an in-\/memory layer and a disk layer, paired with a write-\/ahead log (WAL) for persistence of in-\/memory changes.

When you instantiate a {\ttfamily \doxylink{classvkdb_1_1_database}{vkdb\+::\+Database}}, all of the prior in-\/memory information (in-\/memory layer, metadata, etc.) will be loaded in if the database already exists, and if not, a new one is set up. This persists on disk until you clear it via {\ttfamily vkdb\+::\+Database\+::clear}.

It\textquotesingle{}s best to make all interactions via {\ttfamily \doxylink{classvkdb_1_1_database}{vkdb\+::\+Database}}, or the {\ttfamily \doxylink{classvkdb_1_1_table}{vkdb\+::\+Table}} type via {\ttfamily vkdb\+::\+Database\+::get\+Table}, unless you just want to play around with vq (more on this later).

Also, one important thing to note is that all database files will be stored in {\ttfamily vkdb\+::\+DATABASE\+\_\+\+DIRECTORY}; you shouldn\textquotesingle{}t tamper with this directory nor the files in it. 
\begin{DoxyImageNoCaption}
  \mbox{\includegraphics[width=\textwidth,height=\textheight/2,keepaspectratio=true]{dot_inline_dotgraph_1}}
\end{DoxyImageNoCaption}
\hypertarget{md_internals_autotoc_md6}{}\doxysection{\texorpdfstring{Query processing}{Query processing}}\label{md_internals_autotoc_md6}
Lexing is done quite typically, with enumerated token types and line/column number stored for error messages. Initially, I directly executed queries as string streams, but that was a nightmare for robustness.

In terms of parsing, vq has been constructed to have an LL(1) grammarâ€”this meant I could write a straightforward recursive descent parser for the language. This directly converts queries to an abstract syntax tree (AST) with {\ttfamily std\+::variant}.

Finally, the interpreter makes quick use of the AST via the visitor pattern, built into C++ with {\ttfamily std\+::variant} (mentioned earlier) and {\ttfamily std\+::visit}. This ended up making the interpreter (and pretty-\/printer) very satisfying to write.


\begin{DoxyImageNoCaption}
  \mbox{\includegraphics[width=\textwidth,height=\textheight/2,keepaspectratio=true]{dot_inline_dotgraph_2}}
\end{DoxyImageNoCaption}
 